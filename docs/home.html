<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TasteBase - Home</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>

    <div class="topbar">
        <div class="topbar-left" id="nav-home">
            <div class="logo-circle">TB</div>
            <div class="app-name">TasteBase</div>
        </div>
        <div class="topbar-right">
            <span class="badge" id="nav-current">Dashboard</span>
            <button class="btn-outline" id="nav-profile">Profile</button>
            <button class="btn" id="nav-logout">Sign Out</button>
        </div>
    </div>

    <div class="page">
        <div class="page-title">Welcome back!</div>
        <div class="subtle">Search, view, or add new recipes.</div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search recipes...">
            <button class="icon-btn" id="search-btn">üîç</button>
        </div>

        <div class="section-header">
            <h3>Your Recipes</h3>
            <div class="action-row">
                <button class="btn-outline" id="btn-favorites">‚òÖ Favorites Only</button>
                <button class="btn" id="btn-add">+ Add</button>
                <button class="btn-gold" id="btn-smart" style="display:none;">‚ú¶ Smart Add</button>
            </div>
        </div>

        <div class="card-grid" id="recipe-grid"></div>
    </div>

    <div id="smart-modal" class="form-card"
         style="display:none; position:fixed; top:20%; left:50%;
            transform:translateX(-50%); z-index:10; width:90%; max-width:420px;">

        <h3>Smart Add Recipe</h3>
        <p class="subtle">Optional: Describe what kind of recipe you want.</p>

        <div class="form-group">
            <label>Prompt</label>
            <textarea id="smart-prompt" placeholder="Ex: Make a pasta recipe using mushrooms and garlic"></textarea>
        </div>

        <div class="action-row" style="justify-content: flex-end;">
            <button class="btn-outline" id="smart-cancel">Cancel</button>
            <button class="btn" id="smart-submit">Generate</button>
        </div>
    </div>

    <script>
        const API_BASE = "https://tastebase-api.onrender.com";
        const token = localStorage.getItem("token");
        if (!token) location.href = "login.html";

        // NAV
        document.getElementById("nav-home").onclick = () => location.href = "home.html";
        document.getElementById("nav-profile").onclick = () => location.href = "profile.html";
        document.getElementById("nav-logout").onclick = () => {
            localStorage.clear();
            location.href = "index.html";
        };

        document.getElementById("btn-add").onclick = () => location.href = "edit-recipe.html";

        let favoritesOnly = false;

        async function loadRecipes() {
            const url = favoritesOnly ? `${API_BASE}/api/recipes?favorite=true` : `${API_BASE}/api/recipes`;
            const res = await fetch(url, { headers: { Authorization: "Bearer " + token } });
            const list = await res.json();
            renderGrid(list);
        }

        function renderGrid(list) {
            const grid = document.getElementById("recipe-grid");
            grid.innerHTML = "";

            if (!list.length) {
                grid.innerHTML = `<div class="subtle">No recipes yet. Click + Add to create one.</div>`;
                return;
            }

            list.forEach(r => {
                const div = document.createElement("div");
                div.className = "recipe-card";

                // clicking background opens recipe
                div.addEventListener("click", () => {
                    location.href = `view-recipe.html?id=${r._id}`;
                });

                const img = document.createElement("div");
                img.className = "thumb";
                img.style.backgroundImage = r.imageUrl ? `url('${r.imageUrl}')` : "none";
                img.style.backgroundSize = "cover";
                img.style.backgroundPosition = "center";

                const title = document.createElement("div");
                title.className = "recipe-card-title";
                title.textContent = r.title;

                const preview = document.createElement("div");
                preview.className = "recipe-card-meta";
                preview.textContent = (r.text || "").substring(0, 60) + "...";

                // FAVORITE BUTTON
                const favBtn = document.createElement("button");
                favBtn.className = "icon-btn";
                favBtn.innerHTML = r.favorite ? "‚òÖ" : "‚òÜ";
                favBtn.style.fontSize = "1.5rem";
                favBtn.style.color = r.favorite ? "gold" : "#999";

                // prevent clicking this from opening the recipe page
                favBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();

                    const updated = await fetch(`${API_BASE}/api/recipes/${r._id}/favorite`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: "Bearer " + token
                        }
                    });

                    if (updated.ok) {
                        // reload recipes to update stars
                        loadRecipes();
                    }
                });

                const meta = document.createElement("div");
                meta.className = "recipe-card-meta subtle";
                meta.appendChild(favBtn);

                div.append(img, title, preview, meta);
                grid.append(div);
            });
        }

        // Fetch profile to check premium status
        async function checkPremium() {
            const res = await fetch(`${API_BASE}/api/upgrade/profile`, {
                headers: { Authorization: "Bearer " + token }
            });

            if (!res.ok) return; // fail quietly

            const user = await res.json();
            const btnSmart = document.getElementById("btn-smart");

            if (user.isPremium) btnSmart.style.display = "inline-flex";
        }

        checkPremium();

        document.getElementById("btn-favorites").onclick = () => {
            favoritesOnly = !favoritesOnly;
            document.getElementById("btn-favorites").textContent =
                favoritesOnly ? "‚òÖ Showing Favorites" : "‚òÖ Favorites Only";
            loadRecipes();
        };

        document.getElementById("search-btn").onclick = () => {
            const term = document.getElementById("search-input").value.trim();
            if (!term) return;
            location.href = `search.html?q=${encodeURIComponent(term)}`;
        };

        loadRecipes();

        // ELEMENTS
        const modal = document.getElementById("smart-modal");
        const submitSmart = document.getElementById("smart-submit");
        const cancelSmart = document.getElementById("smart-cancel");

        // Show modal
        document.getElementById("btn-smart").onclick = () => {
            modal.style.display = "block";
        };

        // Hide modal
        cancelSmart.onclick = () => {
            modal.style.display = "none";
        };

        // Submit Smart Add
        submitSmart.onclick = async () => {
            const prompt = document.getElementById("smart-prompt").value.trim();

            const res = await fetch(`${API_BASE}/api/recipes/smart`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify({ prompt })
            });

            if (!res.ok) {
                alert("Smart Add failed: " + (await res.text()));
                return;
            }

            modal.style.display = "none";
            document.getElementById("smart-prompt").value = "";

            loadRecipes(); // refresh dashboard with new recipe
        };


    </script>
</body>
</html>
