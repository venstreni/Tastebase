<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TasteBase - View Recipe</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <div class="topbar">
        <div class="topbar-left" id="nav-home">
            <div class="logo-circle">TB</div>
            <div class="app-name">TasteBase</div>
        </div>
        <div class="topbar-right">
            <span class="badge" id="nav-current">View</span>
            <button class="btn-outline" id="nav-profile">Profile</button>
            <button class="btn" id="nav-logout">Sign Out</button>
        </div>
    </div>

    <div class="page">
        <div class="recipe-view" id="recipe-view" style="display:none;">
            <div class="recipe-view-main">
                <div class="thumb" id="recipe-thumb" style="
                    width:100%;
                    height:200px;
                    border-radius: 1rem;
                    background-size: cover;
                    background-position: center;
                    background-color: #f3eded;
                    margin-bottom: 1rem;">
                </div>
                <h1 id="r-title"></h1>
                <div id="r-body"></div>
                <div class="top-actions">
                    <button class="btn" id="edit-btn">Edit</button>
                    <button class="btn-outline" id="delete-btn">Delete</button>
                </div>
            </div>
            <div class="recipe-view-side">
                <button class="btn" id="export-json">Export JSON</button>
                <button class="btn-outline" id="export-text">Export Text</button>
                <button class="btn-outline" id="export-html">Export HTML</button>
            </div>
        </div>

        <div class="subtle" id="loading">Loading recipe...</div>
    </div>

    <script>
        const API_BASE = "https://tastebase.onrender.com";
        const token = localStorage.getItem("token");
        if (!token) location.href = "login.html";

        // GLOBAL RECIPE STORE
        let currentRecipe = null;

        // NAVIGATION
        document.getElementById("nav-home").onclick = () => location.href = "home.html";
        document.getElementById("nav-profile").onclick = () => location.href = "profile.html";
        document.getElementById("nav-logout").onclick = () => {
            localStorage.clear();
            location.href = "index.html";
        };

        const params = new URLSearchParams(location.search);
        const id = params.get("id");

        loadRecipe();

        async function loadRecipe() {
            try {
                const res = await fetch(`${API_BASE}/api/recipes/${id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!res.ok) {
                    alert("Error loading recipe");
                    return;
                }

                // READ THE BODY **ONCE**
                currentRecipe = await res.json();

                // SHOW PAGE
                document.getElementById("loading").style.display = "none";
                document.getElementById("recipe-view").style.display = "flex";

                // THUMBNAIL
                const thumb = document.getElementById("recipe-thumb");
                if (currentRecipe.imageUrl?.trim()) {
                    thumb.style.backgroundImage = `url('${currentRecipe.imageUrl}')`;
                } else {
                    thumb.style.backgroundImage = "none";
                }

                // POPULATE CONTENT
                document.getElementById("r-title").textContent = currentRecipe.title;
                document.getElementById("r-body").innerHTML = marked.parse(currentRecipe.text || "");

                // BUTTONS
                document.getElementById("edit-btn").onclick =
                    () => location.href = `edit-recipe.html?id=${id}`;

                document.getElementById("delete-btn").onclick = async () => {
                    if (!confirm("Delete this recipe?")) return;

                    await fetch(`${API_BASE}/api/recipes/${id}`, {
                        method: "DELETE",
                        headers: { Authorization: `Bearer ${token}` }
                    });

                    location.href = "home.html";
                };

                // EXPORT HANDLERS
                document.getElementById("export-json").onclick = () => exportRecipe("json");
                document.getElementById("export-text").onclick = () => exportRecipe("text");
                document.getElementById("export-html").onclick = () => exportRecipe("html");

            } catch (err) {
                console.error("Load failed:", err);
                alert("Failed to load recipe.");
            }
        }

        // =========================
        //  EXPORT HANDLERS
        // =========================
        async function exportRecipe(format) {
            if (!currentRecipe) {
                return alert("Recipe not loaded yet.");
            }

            try {
                const res = await fetch(
                    `${API_BASE}/api/recipes/${id}/export?format=${format}`,
                    { headers: { Authorization: "Bearer " + token } }
                );

                if (!res.ok) {
                    console.error(await res.text());
                    alert("Export failed.");
                    return;
                }

                const filename = currentRecipe.title
                    .replace(/[^a-z0-9]/gi, "_")
                    .toLowerCase();

                if (format === "json") {
                    const data = await res.json();
                    downloadBlob(JSON.stringify(data, null, 2), filename + ".json", "application/json");
                } else {
                    const data = await res.text();
                    const type = format === "text" ? "text/plain" : "text/html";
                    const ext = format === "text" ? ".txt" : ".html";
                    downloadBlob(data, filename + ext, type);
                }

            } catch (err) {
                console.error(err);
                alert("Export failed.");
            }
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");

            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>

</body>
</html>
