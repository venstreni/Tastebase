<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TasteBase - Edit Recipe</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>

    <div class="topbar">
        <div class="topbar-left" id="nav-home">
            <div class="logo-circle">TB</div>
            <div class="app-name">TasteBase</div>
        </div>
        <div class="topbar-right">
            <span class="badge" id="nav-current">Edit</span>
            <button class="btn-outline" id="nav-profile">Profile</button>
            <button class="btn" id="nav-logout">Sign Out</button>
        </div>
    </div>

    <div class="page">
        <div class="page-title" id="title-label">New Recipe</div>

        <div class="form-card">
            <div class="form-group">
                <label>Title</label>
                <input id="title-input" type="text">
            </div>

            <div class="form-group">
                <label>Recipe Text (Markdown supported)</label>
                <textarea id="text-input"></textarea>
            </div>

            <div class="form-group">
                <label>Cover Image URL</label>
                <input id="img-input" type="text">
            </div>

            <div class="action-row">
                <button class="btn" id="save-btn">Save</button>
                <button class="btn-outline" id="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://tastebase.onrender.com";
        const token = localStorage.getItem("token");
        if (!token) location.href = "login.html";

        // NAV
        document.getElementById("nav-home").onclick = () => location.href = "home.html";
        document.getElementById("nav-profile").onclick = () => location.href = "profile.html";
        document.getElementById("nav-logout").onclick = () => {
            localStorage.clear();
            location.href = "index.html";
        };

        const params = new URLSearchParams(location.search);
        const id = params.get("id");
        const isEdit = Boolean(id);

        if (isEdit) loadExisting();

        async function loadExisting() {
            document.getElementById("title-label").textContent = "Edit Recipe";
            const res = await fetch(`${API_BASE}/api/recipes/${id}`, {
                headers: { Authorization: "Bearer " + token }
            });
            const recipe = await res.json();
            document.getElementById("title-input").value = recipe.title;
            document.getElementById("text-input").value = recipe.text;
            document.getElementById("img-input").value = recipe.imageUrl || "";
        }

        // SAVE
        document.getElementById("save-btn").onclick = async () => {
            const data = {
                title: document.getElementById("title-input").value.trim(),
                text: document.getElementById("text-input").value.trim(),
                imageUrl: document.getElementById("img-input").value.trim()
            };

            const url = isEdit ? `${API_BASE}/api/recipes/${id}` : `${API_BASE}/api/recipes`;
            const method = isEdit ? "PUT" : "POST";

            await fetch(url, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify(data)
            });

            location.href = "home.html";
        };

        document.getElementById("cancel-btn").onclick = () =>
            location.href = "home.html";
    </script>

</body>
</html>
